# üìÖ M√≥dulo de Gesti√≥n de Turnos para Servicios de Bienestar

## üìå Descripci√≥n del M√≥dulo

Este m√≥dulo permite a los miembros de la comunidad universitaria (estudiantes, docentes, administrativos y personal de
servicios generales) gestionar y visualizar turnos para atenci√≥n en los servicios de bienestar institucional: medicina
general, odontolog√≠a y psicolog√≠a.  
El sistema contempla la asignaci√≥n de turnos desde tablets de autoservicio, control administrativo por parte del
personal autorizado y seguimiento por parte de los profesionales de la salud.

---

## üõ†Ô∏è Tecnolog√≠as Utilizadas

- **Java 17**
- **Spring Boot**
- **PostgreSQL**
- **Spring Cloud Bus**
- **JWT (JSON Web Token)**
- **Lombok**
- **Maven**
- **Swagger**

---

## üîß Funcionamiento del M√≥dulo

### üîó Interacci√≥n con Otros M√≥dulos

El m√≥dulo opera como un microservicio independiente, orquestado dentro de una arquitectura basada en microservicios y
expuesto mediante un **API Gateway** que gestiona la autenticaci√≥n y el enrutamiento de peticiones.

#### üîÑ Flujo General de Interacci√≥n:

1. **Cliente (Web/M√≥vil)**: Env√≠a solicitudes para turnos m√©dicos al **API Gateway**.
2. **API Gateway**:
    - Obtiene un token JWT desde el **Auth Service**.
    - Valida el token y enruta la petici√≥n al microservicio correspondiente.
3. **Medical Shifts Service**:
    - Verifica el usuario y sus roles a trav√©s del **Users Service**.
    - Procesa la solicitud, registra la informaci√≥n en su base de datos y emite eventos al **Bus de Eventos**.
4. **Estadistics Service**:
    - Consume los eventos generados para generar reportes hist√≥ricos y estad√≠sticas de atenci√≥n.

#### üß© Servicios Relacionados

| Servicio                | Descripci√≥n                                            |
|-------------------------|--------------------------------------------------------|
| **Auth Service**        | Autenticaci√≥n y emisi√≥n de tokens JWT                  |
| **API Gateway**         | Enrutamiento y control de acceso                       |
| **Users Service**       | Consulta y validaci√≥n de usuarios                      |
| **Estadistics Service** | Registro hist√≥rico y generaci√≥n de reportes            |
| **Event Bus**           | Middleware de eventos asincr√≥nicos (Kafka + Cloud Bus) |

#### üîó Diagrama de Microservicios

![microservicios](<assets/imgs/diagrams/microservices.png>)

### üèóÔ∏è Estilo Arquitect√≥nico

[DOCUMENTO DE ARQUITECTURA BACKEND](<assets/docs/Backend-architecture.pdf>)

### ‚öôÔ∏è Funcionamiento Interno

El **MOD-LLL-001: M√≥dulo de Turnos M√©dicos** expone una API RESTful para gestionar la creaci√≥n, consulta y modificaci√≥n
de turnos. Utiliza autenticaci√≥n basada en JWT y eventos distribuidos para la comunicaci√≥n entre servicios. Incluye
integraci√≥n con tablets para asignaci√≥n f√≠sica de turnos y m√≥dulos visuales para pantallas de atenci√≥n.

> üîç _M√°s detalles disponibles en el documento de an√°lisis de requerimientos._

[An√°lisis Requerimientos](<assets/docs/Requirements-analysis.pdf>)

---

## üìä Diagramas del Sistema

- [ ] Diagrama de Clases

![Diagrama de Clases](<assets/imgs/diagrams/class.jpg>)

El diagrama de clases representa las principales entidades involucradas en la gesti√≥n de turnos en el contexto de
bienestar universitario.  
Cada clase encapsula atributos y relaciones espec√≠ficas para reflejar el comportamiento y la estructura del sistema.

### Clases Principales

### `User`

- Representa a los usuarios que pueden solicitar turnos.
- **Atributos**: `id`, `name`, `role`
- **Relaciones**: Tiene una relaci√≥n con la clase `Turn` como paciente.

### `Doctor`

- Representa a los profesionales encargados de atender turnos.
- **Atributos**: `userId`, `speciality`
- **Relaciones**: Se relaciona con un `User` y est√° asociado a una especialidad m√©dica.

### `Turn`

- Contiene la informaci√≥n de los turnos asignados o solicitados.
- **Atributos**: `id`, `code`, `date`, `levelAttention`, `priority`, `speciality`, `status`, `dateAttention`
- **Asociaciones**:
    - Un `Doctor` que atiende el turno.
    - Un `User` que solicita el turno.

### `UniversityWelfare`

- Contiene configuraciones relacionadas con la disponibilidad de turnos.
- **Atributos**: `id`, `disableTurns`, `disableTurnsBySpeciality` (lista de especialidades deshabilitadas)

### `Multimedia`

- Gestiona contenido informativo relacionado al servicio.
- **Atributos**: `id`, `name`, `type`, `url`, `duration`

### `SpecialitySequence`

- Lleva el control de la numeraci√≥n secuencial de turnos por especialidad.
- **Atributos**: `id`, `speciality`, `sequence`

Astha Diagrama de
clases: [Astha Diagrama de clases](<assets/docs/Class-diagrams.asta>)

- [ ] Diagrama de Componentes

![Diagrama de Componentes](<assets/imgs/diagrams/components.jpg>)

El siguiente diagrama de componentes permite evidenciar el flujo completo y la estructura funcional del sistema *
*MedicalTurns**, abarcando desde la interfaz de usuario hasta la integraci√≥n con servicios externos.

### Componentes Principales

### `UniversityWelfareService`

- Se encarga de la gesti√≥n de turnos, incluyendo su creaci√≥n y actualizaci√≥n.

### `ReportService`

- Recopila y env√≠a los datos necesarios para el an√°lisis estad√≠stico.
- Esta informaci√≥n es procesada por el servicio externo `bismuto-statistics-service`, el cual genera las estad√≠sticas
  cuando son solicitadas.

### `MultimediaService`

- Administra los elementos multimedia del m√≥dulo, como im√°genes y videos.
- Se apoya en el `MultimediaController` para exponer estos recursos a trav√©s de la API.


- [ ] Diagrama de Secuencia

[Diagramas de secuencia](<assets/docs/Sequence-Diagrams.pdf>)

En esta secci√≥n se documentan los distintos **diagramas de secuencia** que describen la interacci√≥n entre componentes
del sistema a lo largo del tiempo, espec√≠ficamente en los flujos clave definidos para cada m√≥dulo funcional. Estos
diagramas son fundamentales para visualizar c√≥mo los distintos servicios, controladores y entidades colaboran para
cumplir con los casos de uso definidos.

### Organizaci√≥n de los Diagramas

Los diagramas de secuencia est√°n organizados en carpetas bajo el directorio `sequence-diagrams`, de acuerdo con los
m√≥dulos funcionales y t√©cnicos del sistema. La estructura sigue el patr√≥n de **arquitectura de capas**:

- `controller/`: contiene los diagramas centrados en las interacciones a nivel de API y controladores HTTP.
- `service/`: contiene los diagramas que detallan la l√≥gica de negocio y c√≥mo los servicios internos del sistema
  gestionan los procesos.

Cada subcarpeta dentro de `controller` y `service` corresponde a un m√≥dulo espec√≠fico del sistema:

- `multimedia-controller` y `multimedia-service`  
  Documentan los flujos relacionados con la carga, consulta y validaci√≥n de archivos multimedia asociados a turnos
  m√©dicos o usuarios.

- `report-controller`  
  Contiene diagramas que representan la comunicaci√≥n entre el sistema principal y el m√≥dulo externo de estad√≠sticas y
  reportes, as√≠ como la exposici√≥n de esos datos al usuario.

- `university-welfare-controller` y `university-welfare-service`  
  Representan las operaciones relacionadas con el bienestar universitario, incluyendo flujos de asistencia social o
  seguimiento de estudiantes.

- `turn-service`  
  Incluye los diagramas para la gesti√≥n de turnos m√©dicos, como la asignaci√≥n, finalizaci√≥n (por asistencia o no
  asistencia) y consulta de disponibilidad.

---

Estos diagramas permiten una comprensi√≥n clara del comportamiento del sistema en tiempo de ejecuci√≥n y son una
herramienta √∫til tanto para desarrolladores como para analistas funcionales.

- [ ] Diagrama de Datos

![Diagrama de Datos](<assets/imgs/diagrams/data.jpg>)

El sistema utiliza una base de datos relacional (**PostgreSQL**) cuyo modelo representa las entidades clave involucradas
en la gesti√≥n de turnos dentro del contexto de bienestar universitario.

A continuaci√≥n, se describen las tablas principales y su prop√≥sito:

### `app_user`

Representa a los usuarios del sistema (como estudiantes o personal administrativo).  
Aunque el sistema general cuenta con un m√≥dulo centralizado de autenticaci√≥n, este microservicio almacena localmente la
tabla `app_user` para evitar una dependencia directa, garantizando la **autonom√≠a y resiliencia** del servicio, en
conformidad con los principios de dise√±o de microservicios.

### `doctor`

Representa a los profesionales encargados de atender los turnos.  
Est√° asociado directamente a un registro en `app_user` y contiene informaci√≥n adicional como la **especialidad m√©dica**.

### `turn`

Registra los turnos solicitados por los usuarios, incluyendo atributos como:

- C√≥digo
- Fecha
- Nivel de atenci√≥n
- Prioridad
- Especialidad
- Estado del turno

Cada turno se asocia tanto a un usuario como a un doctor.

### `university_welfare`

Define la configuraci√≥n general del servicio de bienestar universitario, incluyendo si los **turnos est√°n habilitados o
deshabilitados**.

### `disable_turns_speciality`

Relaciona las especialidades con los servicios de bienestar que tienen **turnos deshabilitados**.  
Esta tabla permite representar m√∫ltiples especialidades deshabilitadas por instancia de bienestar, solventando la
limitaci√≥n de las bases de datos relacionales respecto al almacenamiento de listas.

### `multimedia`

Almacena contenido informativo como **videos o im√°genes** relacionados con el servicio. Incluye atributos como:

- Duraci√≥n
- Nombre
- Tipo
- URL

### `speciality_sequence`

Lleva un control de **numeraci√≥n secuencial por especialidad**, lo que permite asignar un n√∫mero de turno ordenado por
tipo de atenci√≥n m√©dica.

---

## üöÄ Funcionalidades del M√≥dulo

### üì° Endpoints REST

Puedes consumir el API ya desplegado accediendo a su documentaci√≥n en l√≠nea:

- **Swagger en Azure:**

```
https://diamante-medicalturns-develop-dvb8c2cqfbh4gwbg.canadacentral-01.azurewebsites.net/swagger-ui/index.html
```  

### üòä Happy Path

| Escenario                               | Resultado esperado                                                  |
|-----------------------------------------|---------------------------------------------------------------------|
| Crear un nuevo turno                    | Se registra el turno y se devuelve el turno creado                  |
| Obtener lista de turnos disponibles     | Se devuelve una lista actualizada de turnos                         |
| Eliminar un turno existente             | Se elimina correctamente y se confirma la operaci√≥n                 |
| Consultar turnos por fecha espec√≠fica   | Se devuelve lista de turnos correspondientes a la fecha             |
| Consultar turnos por usuario espec√≠fico | Se devuelve lista de turnos asignados al usuario                    |
| Consultar turnos por especialidad       | Se devuelve lista de turnos filtrados por especialidad              |
| Habilitar turnos                        | Se habilitan los turnos y se confirma la habilitaci√≥n               |
| Deshabilitar turnos                     | Se deshabilitan los turnos y se confirma la acci√≥n                  |
| Obtener el √∫ltimo turno llamado         | Se devuelve el √∫ltimo turno que fue llamado                         |
| Obtener turnos pendientes               | Se devuelve la lista de turnos en estado pendiente                  |
| Subir nuevo archivo multimedia          | Se sube correctamente el archivo y se devuelve el multimedia creado |
| Listar todos los archivos multimedia    | Se devuelve lista de todos los elementos multimedia                 |
| Consultar √∫ltimo elemento multimedia    | Se devuelve el elemento multimedia m√°s reciente                     |
| Consultar multimedia por ID             | Se devuelve el elemento multimedia correspondiente al ID            |
| Eliminar multimedia por ID              | Se elimina el elemento multimedia y se confirma la acci√≥n           |
| Deshabilitar turnos de una especialidad | Se deshabilitan turnos de la especialidad indicada                  |
| Habilitar turnos de una especialidad    | Se habilitan turnos de la especialidad indicada                     |

### üö® Manejo de Errores

| C√≥digo | Mensaje de error             | Causa probable                         |
|--------|------------------------------|----------------------------------------|
| 400    | "Datos de entrada inv√°lidos" | Validaciones fallidas en el formulario |
| 401    | "Usuario no autenticado"     | Token inv√°lido o ausente               |
| 404    | "Turnos no disponibles"      | Los turnos est√°n deshabilitados        |
| 404    | "Especialidad no disponible" | Especialidad deshabilitada             |
| 500    | "Error interno del servidor" | Fallo inesperado                       |

---

## üì¨ Uso de Colas de Mensajer√≠a

| T√≥pico Kafka | Evento Disparado | Resultado Esperado | Happy Path | Dead Letter Queue (DLQ) |
|--------------|------------------|--------------------|------------|-------------------------|
| x            | x                | x                  | x          | x                       |

---

## üß™ Evidencia de Pruebas

- Las pruebas est√°n ubicadas en:  
  `src/test/java/eci/cvds/ecibeneficio/diamante_medicalturns_service`

- Tecnolog√≠as utilizadas:
    - **JUnit 5**
    - **Mockito**
    - **Spring Boot Test**

### ‚ñ∂Ô∏è Ejecutar pruebas:

```bash
mvn test
```

---

## ‚ñ∂Ô∏è Instrucciones para Ejecutar el Proyecto

### üöÄ De forma local

1. **Clona el repositorio:**

```bash
git clone https://github.com/ECIBienestar/diamante-medicalturns-service.git
```

2. **Navega a la ra√≠z del proyecto:**

```bash
cd diamante_medicalturns_service
```

3. **Ejecuta el servicio con Maven:**

```bash
./mvnw spring-boot:run
```

4. **Accede al Swagger local:**

```
http://localhost:8080/swagger-ui.html
```

---

## üöÄ Evidencia de CI/CD y Despliegue

- El proyecto se encuentra desplegado en Azure.  
  üëâ [Despliegue para pruebas](diamante-medicalturns-develop-dvb8c2cqfbh4gwbg.canadacentral-01.azurewebsites.net)  
  üëâ [Despliegue para produccion](diamante-medicalturns-dzdja4b4bfayaqdk.canadacentral-01.azurewebsites.net)
- Pipelines configurados:
    - GitHub Actions para pruebas y builds
    - Azure Pipelines para despliegue autom√°tico

---

## üóÇÔ∏è Estructura del Proyecto

```
C:.
‚îú‚îÄ‚îÄ‚îÄ.github
‚îÇ   ‚îî‚îÄ‚îÄ‚îÄworkflows
‚îú‚îÄ‚îÄ‚îÄ.mvn
‚îÇ   ‚îî‚îÄ‚îÄ‚îÄwrapper
‚îú‚îÄ‚îÄ‚îÄassets
‚îÇ   ‚îú‚îÄ‚îÄ‚îÄdocs
‚îÇ   ‚îî‚îÄ‚îÄ‚îÄimgs
‚îú‚îÄ‚îÄ‚îÄsrc
‚îÇ   ‚îú‚îÄ‚îÄ‚îÄmain
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ‚îÄjava
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄeci
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ‚îÄcvds
‚îÇ   ‚îÇ   ‚îÇ           ‚îî‚îÄ‚îÄ‚îÄecibeneficio
‚îÇ   ‚îÇ   ‚îÇ               ‚îî‚îÄ‚îÄ‚îÄdiamante_medicalturns_service
‚îÇ   ‚îÇ   ‚îÇ                   ‚îú‚îÄ‚îÄ‚îÄconfig
‚îÇ   ‚îÇ   ‚îÇ                   ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄinitializer
‚îÇ   ‚îÇ   ‚îÇ                   ‚îú‚îÄ‚îÄ‚îÄcontroller
‚îÇ   ‚îÇ   ‚îÇ                   ‚îú‚îÄ‚îÄ‚îÄdto
‚îÇ   ‚îÇ   ‚îÇ                   ‚îÇ   ‚îú‚îÄ‚îÄ‚îÄrequest
‚îÇ   ‚îÇ   ‚îÇ                   ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄresponse
‚îÇ   ‚îÇ   ‚îÇ                   ‚îú‚îÄ‚îÄ‚îÄexception
‚îÇ   ‚îÇ   ‚îÇ                   ‚îú‚îÄ‚îÄ‚îÄfactory
‚îÇ   ‚îÇ   ‚îÇ                   ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄimpl
‚îÇ   ‚îÇ   ‚îÇ                   ‚îú‚îÄ‚îÄ‚îÄmodel
‚îÇ   ‚îÇ   ‚îÇ                   ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄenums
‚îÇ   ‚îÇ   ‚îÇ                   ‚îú‚îÄ‚îÄ‚îÄrepository
‚îÇ   ‚îÇ   ‚îÇ                   ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄprojection
‚îÇ   ‚îÇ   ‚îÇ                   ‚îú‚îÄ‚îÄ‚îÄservice
‚îÇ   ‚îÇ   ‚îÇ                   ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄimpl
‚îÇ   ‚îÇ   ‚îÇ                   ‚îî‚îÄ‚îÄ‚îÄutils
‚îÇ   ‚îÇ   ‚îÇ                       ‚îú‚îÄ‚îÄ‚îÄenums
‚îÇ   ‚îÇ   ‚îÇ                       ‚îî‚îÄ‚îÄ‚îÄmapper
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄresources
‚îÇ   ‚îî‚îÄ‚îÄ‚îÄtest
‚îÇ       ‚îî‚îÄ‚îÄ‚îÄjava
‚îÇ           ‚îî‚îÄ‚îÄ‚îÄeci
‚îÇ               ‚îî‚îÄ‚îÄ‚îÄcvds
‚îÇ                   ‚îî‚îÄ‚îÄ‚îÄecibeneficio
‚îÇ                       ‚îî‚îÄ‚îÄ‚îÄdiamante_medicalturns_service
‚îî‚îÄ‚îÄ‚îÄtarget
    ‚îú‚îÄ‚îÄ‚îÄclasses
    ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄeci
    ‚îÇ       ‚îî‚îÄ‚îÄ‚îÄcvds
    ‚îÇ           ‚îî‚îÄ‚îÄ‚îÄecibeneficio
    ‚îÇ               ‚îî‚îÄ‚îÄ‚îÄdiamante_medicalturns_service
    ‚îÇ                   ‚îú‚îÄ‚îÄ‚îÄconfig
    ‚îÇ                   ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄinitializer
    ‚îÇ                   ‚îú‚îÄ‚îÄ‚îÄcontroller
    ‚îÇ                   ‚îú‚îÄ‚îÄ‚îÄdto
    ‚îÇ                   ‚îÇ   ‚îú‚îÄ‚îÄ‚îÄrequest
    ‚îÇ                   ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄresponse
    ‚îÇ                   ‚îú‚îÄ‚îÄ‚îÄexception
    ‚îÇ                   ‚îú‚îÄ‚îÄ‚îÄfactory
    ‚îÇ                   ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄimpl
    ‚îÇ                   ‚îú‚îÄ‚îÄ‚îÄmodel
    ‚îÇ                   ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄenums
    ‚îÇ                   ‚îú‚îÄ‚îÄ‚îÄrepository
    ‚îÇ                   ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄprojection
    ‚îÇ                   ‚îú‚îÄ‚îÄ‚îÄservice
    ‚îÇ                   ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄimpl
    ‚îÇ                   ‚îî‚îÄ‚îÄ‚îÄutils
    ‚îÇ                       ‚îú‚îÄ‚îÄ‚îÄenums
    ‚îÇ                       ‚îî‚îÄ‚îÄ‚îÄmapper
    ‚îú‚îÄ‚îÄ‚îÄgenerated-sources
    ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄannotations
    ‚îú‚îÄ‚îÄ‚îÄgenerated-test-sources
    ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄtest-annotations
    ‚îú‚îÄ‚îÄ‚îÄmaven-status
    ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄmaven-compiler-plugin
    ‚îÇ       ‚îú‚îÄ‚îÄ‚îÄcompile
    ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄdefault-compile
    ‚îÇ       ‚îî‚îÄ‚îÄ‚îÄtestCompile
    ‚îÇ           ‚îî‚îÄ‚îÄ‚îÄdefault-testCompile
    ‚îú‚îÄ‚îÄ‚îÄsurefire-reports
    ‚îî‚îÄ‚îÄ‚îÄtest-classes
        ‚îî‚îÄ‚îÄ‚îÄeci
            ‚îî‚îÄ‚îÄ‚îÄcvds
                ‚îî‚îÄ‚îÄ‚îÄecibeneficio
                    ‚îî‚îÄ‚îÄ‚îÄdiamante_medicalturns_service
```

---

## üìù Documentaci√≥n del C√≥digo

Todo el c√≥digo fuente cuenta con documentaci√≥n mediante JavaDoc:

- üìò **Clases** documentadas con su prop√≥sito.
- üîß **M√©todos** descritos con entradas, salidas y comportamiento.
- üß© **Propiedades** explicadas seg√∫n su funci√≥n dentro del modelo.

---

**üìå Nota:** Este README se actualizar√° conforme avance el desarrollo del proyecto.
