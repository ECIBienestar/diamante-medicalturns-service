# üìÖ M√≥dulo de Gesti√≥n de Turnos para Servicios de Bienestar

## üìå Descripci√≥n del M√≥dulo

Este m√≥dulo permite a los miembros de la comunidad universitaria (estudiantes, docentes, administrativos y personal de servicios generales) gestionar y visualizar turnos para atenci√≥n en los servicios de bienestar institucional: medicina general, odontolog√≠a y psicolog√≠a.  
El sistema contempla la asignaci√≥n de turnos desde tablets de autoservicio, control administrativo por parte del personal autorizado y seguimiento por parte de los profesionales de la salud.

---

## üõ†Ô∏è Tecnolog√≠as Utilizadas

- **Java 17**
- **Spring Boot**
- **PostgreSQL**
- **Apache Kafka**
- **Spring Cloud Bus**
- **JWT (JSON Web Token)**
- **Lombok**
- **Maven**
- **Swagger**

---

## üîß Funcionamiento del M√≥dulo

### üîó Interacci√≥n con Otros M√≥dulos

El m√≥dulo opera como un microservicio independiente, orquestado dentro de una arquitectura basada en microservicios y expuesto mediante un **API Gateway** que gestiona la autenticaci√≥n y el enrutamiento de peticiones.

#### üîÑ Flujo General de Interacci√≥n:

1. **Cliente (Web/M√≥vil)**: Env√≠a solicitudes para turnos m√©dicos al **API Gateway**.
2. **API Gateway**:
   - Obtiene un token JWT desde el **Auth Service**.
   - Valida el token y enruta la petici√≥n al microservicio correspondiente.
3. **Medical Shifts Service**:
   - Verifica el usuario y sus roles a trav√©s del **Users Service**.
   - Procesa la solicitud, registra la informaci√≥n en su base de datos y emite eventos al **Bus de Eventos**.
4. **Estadistics Service**:
   - Consume los eventos generados para generar reportes hist√≥ricos y estad√≠sticas de atenci√≥n.

#### üß© Servicios Relacionados

| Servicio                | Descripci√≥n                                            |
| ----------------------- | ------------------------------------------------------ |
| **Auth Service**        | Autenticaci√≥n y emisi√≥n de tokens JWT                  |
| **API Gateway**         | Enrutamiento y control de acceso                       |
| **Users Service**       | Consulta y validaci√≥n de usuarios                      |
| **Estadistics Service** | Registro hist√≥rico y generaci√≥n de reportes            |
| **Event Bus**           | Middleware de eventos asincr√≥nicos (Kafka + Cloud Bus) |


#### üîó Diagrama de Microservicios
![microservicios](<assets/imgs/Diagrama de Microservicios.png>)


### üèóÔ∏è Estilo Arquitect√≥nico

[DOCUMENTO DE ARQUITECTURA BACKEND](<assets/docs/DOCUMENTO DE ARQUITECTURA BACKEND.pdf>)

### ‚öôÔ∏è Funcionamiento Interno

El **MOD-LLL-001: M√≥dulo de Turnos M√©dicos** expone una API RESTful para gestionar la creaci√≥n, consulta y modificaci√≥n de turnos. Utiliza autenticaci√≥n basada en JWT y eventos distribuidos para la comunicaci√≥n entre servicios. Incluye integraci√≥n con tablets para asignaci√≥n f√≠sica de turnos y m√≥dulos visuales para pantallas de atenci√≥n.

> üîç _M√°s detalles disponibles en el documento de an√°lisis de requerimientos._

[An√°lisis Requerimientos](<assets/docs/An√°lisis Requerimientos.pdf>)

---

## üìä Diagramas del Sistema

- [ ] Diagrama de Clases

![Diagrama de Clases](<assets/imgs/Diagrama de Clases v2.jpg>)

Astha Diagrama de clases: [Astha Diagrama de clases](<assets/docs/diamante_medicalturns_service - Diagrama de clases.asta>)

- [ ] Diagrama de Componentes

1. Turn Management Service
   ![Turn Management Service](<assets/imgs/Diagrama de Componentes 1.png>)
2. Multimedia Management Service
   ![Multimedia Management Service](<assets/imgs/Diagrama de Componentes 2.png>)
3. Report Service
   ![Report Service](<assets/imgs/Diagrama de Componentes 3.png>)
4. Notification Service

![Notification Service](<assets/imgs/Diagrama de Componentes 5.png>)


- [ ] Diagrama de Secuencia

  > Aun por Definir

- [ ] Diagrama de Datos

      ![Diagrama de Datos](<assets/imgs/Diagrama de Datos.png>)
      
![Diagrama de Datos](<assets/imgs/Diagrama de Datos v2.jpg>)

---

## üöÄ Funcionalidades del M√≥dulo

### üì° Endpoints REST

| M√©todo | Endpoint                                | Descripci√≥n                                                           | Entrada                   | Salida                                  |
| ------ | --------------------------------------- | --------------------------------------------------------------------- | ------------------------- | --------------------------------------- |
| POST   | `/api/turns`                            | Crea un nuevo turno                                                   | `CreateTurnRequest`       | `ApiResponse<TurnResponse>`             |
| GET    | `/api/turns`                            | Devuelve todos los turnos del d√≠a actual                              | N/A                       | `ApiResponse<List<TurnResponse>>`       |
| GET    | `/api/turns/{speciality}`               | Devuelve los turnos del d√≠a por especialidad                          | `speciality` (path param) | `ApiResponse<List<TurnResponse>>`       |
| GET    | `/api/turns/last-turn`                  | Devuelve el √∫ltimo turno llamado                                      | N/A                       | `ApiResponse<TurnResponse>`             |
| GET    | `/api/turns/last-turn/{speciality}`     | Devuelve el √∫ltimo turno de una especialidad                          | `speciality` (path param) | `ApiResponse<TurnResponse>`             |
| POST   | `/api/turns/call-next`                  | Llama al siguiente turno en secuencia                                 | `CallTurnRequest`         | `ApiResponse<TurnResponse>`             |
| POST   | `/api/turns/call`                       | Llama a un turno espec√≠fico                                           | `CallTurnRequest`         | `ApiResponse<TurnResponse>`             |
| POST   | `/api/turns/enable`                     | Habilita todos los turnos de todas las especialidades                 | N/A                       | N/A                                     |
| POST   | `/api/turns/disable`                    | Deshabilita todos los turnos de todas las especialidades              | N/A                       | N/A                                     |
| POST   | `/api/turns/enable/{speciality}`        | Habilita los turnos de una especialidad                               | `speciality` (path param) | N/A                                     |
| POST   | `/api/turns/disable/{speciality}`       | Deshabilita los turnos de una especialidad                            | `speciality` (path param) | N/A                                     |
| POST   | `/api/multimedia`                       | Sube nuevo contenido multimedia                                       | `CreateMultimediaRequest` | N/A                                     |
| GET    | `/api/multimedia/{id}`                  | Devuelve un contenido multimedia por ID                               | `id` (path param)         | `ApiResponse<MultimediaResponse>`       |
| GET    | `/api/multimedia`                       | Devuelve la lista de todos los contenidos multimedia                  | N/A                       | `ApiResponse<List<MultimediaResponse>>` |
| DELETE | `/api/multimedia/{id}`                  | Elimina un contenido multimedia por ID                                | `id` (path param)         | N/A                                     |
| GET    | `/api/reports`                          | Devuelve reportes de atenci√≥n seg√∫n el rol del paciente y un rango    | `role`, `start`, `end`    | `ApiResponse<List<ReportResponse>>`     |
| GET    | `/api/reports/attention-level/average`  | Promedio de calidad de atenci√≥n por especialidad                      | `role`, `start`, `end`    | `ApiResponse<Map<String, Integer>>`     |
| GET    | `/api/reports/turns/count-by-specialty` | Distribuci√≥n de turnos por especialidad y tipo de usuario             | `role`, `start`, `end`    | `ApiResponse<Map<String, Integer>>`     |
| GET    | `/api/reports/turns/status`             | Reportes de atenci√≥n filtrados por estado del turno y rango de fechas | `status`, `start`, `end`  | `ApiResponse<List<ReportResponse>>`     |

### üòä Happy Path

| Escenario                               | Resultado esperado                                                  |
| --------------------------------------- | ------------------------------------------------------------------- |
| Crear un nuevo turno                    | Se registra el turno y se devuelve el turno creado                  |
| Obtener lista de turnos disponibles     | Se devuelve una lista actualizada de turnos                         |
| Eliminar un turno existente             | Se elimina correctamente y se confirma la operaci√≥n                 |
| Consultar turnos por fecha espec√≠fica   | Se devuelve lista de turnos correspondientes a la fecha             |
| Consultar turnos por usuario espec√≠fico | Se devuelve lista de turnos asignados al usuario                    |
| Consultar turnos por especialidad       | Se devuelve lista de turnos filtrados por especialidad              |
| Habilitar turnos                        | Se habilitan los turnos y se confirma la habilitaci√≥n               |
| Deshabilitar turnos                     | Se deshabilitan los turnos y se confirma la acci√≥n                  |
| Obtener el √∫ltimo turno llamado         | Se devuelve el √∫ltimo turno que fue llamado                         |
| Obtener turnos pendientes               | Se devuelve la lista de turnos en estado pendiente                  |
| Subir nuevo archivo multimedia          | Se sube correctamente el archivo y se devuelve el multimedia creado |
| Listar todos los archivos multimedia    | Se devuelve lista de todos los elementos multimedia                 |
| Consultar √∫ltimo elemento multimedia    | Se devuelve el elemento multimedia m√°s reciente                     |
| Consultar multimedia por ID             | Se devuelve el elemento multimedia correspondiente al ID            |
| Eliminar multimedia por ID              | Se elimina el elemento multimedia y se confirma la acci√≥n           |
| Deshabilitar turnos de una especialidad | Se deshabilitan turnos de la especialidad indicada                  |
| Habilitar turnos de una especialidad    | Se habilitan turnos de la especialidad indicada                     |

### üö® Manejo de Errores

| C√≥digo | Mensaje de error             | Causa probable                         |
| ------ | ---------------------------- | -------------------------------------- |
| 400    | "Datos de entrada inv√°lidos" | Validaciones fallidas en el formulario |
| 401    | "Usuario no autenticado"     | Token inv√°lido o ausente               |
| 404    | "Turnos no disponibles"      | Los turnos est√°n deshabilitados        |
| 404    | "Especialidad no disponible" | Especialidad deshabilitada             |
| 500    | "Error interno del servidor" | Fallo inesperado                       |

---

## üì¨ Uso de Colas de Mensajer√≠a

| T√≥pico Kafka | Evento Disparado | Resultado Esperado | Happy Path | Dead Letter Queue (DLQ) |
| ------------ | ---------------- | ------------------ | ---------- | ----------------------- |
| x            | x                | x                  | x          | x                       |

---

## üß™ Evidencia de Pruebas

- Las pruebas est√°n ubicadas en:  
  `src/test/java/eci/cvds/ecibeneficio/diamante_medicalturns_service`

- Tecnolog√≠as utilizadas:
  - **JUnit 5**
  - **Mockito**
  - **Spring Boot Test**

### ‚ñ∂Ô∏è Ejecutar pruebas:

```bash
mvn test
```

---

## ‚ñ∂Ô∏è Instrucciones para Ejecutar el Proyecto

### üöÄ De forma local

1. **Clona el repositorio:**

```bash
git clone https://github.com/ECIBienestar/diamante-medicalturns-service.git
```

2. **Navega a la ra√≠z del proyecto:**

```bash
cd diamante_medicalturns_service
```

3. **Ejecuta el servicio con Maven:**

```bash
./mvnw spring-boot:run
```

4. **Accede al Swagger local:**

```
http://localhost:8080/swagger-ui.html
```

---

### ‚òÅÔ∏è Usando el despliegue en Azure

Puedes consumir el API ya desplegado accediendo a su documentaci√≥n en l√≠nea:

- **Swagger en Azure:**

```
https://back-medicalturns-develop-aycucpewbafjhce5.mexicocentral-01.azurewebsites.net/swagger-ui.html
```

Este endpoint se encuentra protegido por autenticaci√≥n JWT, por lo que deber√°s obtener un token desde el **Auth Service** antes de realizar peticiones.

---

## üöÄ Evidencia de CI/CD y Despliegue

- El proyecto se encuentra desplegado en Azure.
- Acceso a la API mediante Swagger:  
  üëâ [Ver en Azure](https://back-medicalturns-develop-aycucpewbafjhce5.mexicocentral-01.azurewebsites.net/swagger-ui.html)
- Pipelines configurados:
  - GitHub Actions para pruebas y builds
  - Azure Pipelines para despliegue autom√°tico

---

## üóÇÔ∏è Estructura del Proyecto

```
C:.
‚îú‚îÄ‚îÄ‚îÄ.github
‚îÇ   ‚îî‚îÄ‚îÄ‚îÄworkflows
‚îú‚îÄ‚îÄ‚îÄ.mvn
‚îÇ   ‚îî‚îÄ‚îÄ‚îÄwrapper
‚îú‚îÄ‚îÄ‚îÄassets
‚îÇ   ‚îú‚îÄ‚îÄ‚îÄdocs
‚îÇ   ‚îî‚îÄ‚îÄ‚îÄimgs
‚îú‚îÄ‚îÄ‚îÄsrc
‚îÇ   ‚îú‚îÄ‚îÄ‚îÄmain
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ‚îÄjava
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄeci
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ‚îÄcvds
‚îÇ   ‚îÇ   ‚îÇ           ‚îî‚îÄ‚îÄ‚îÄecibeneficio
‚îÇ   ‚îÇ   ‚îÇ               ‚îî‚îÄ‚îÄ‚îÄdiamante_medicalturns_service
‚îÇ   ‚îÇ   ‚îÇ                   ‚îú‚îÄ‚îÄ‚îÄconfig
‚îÇ   ‚îÇ   ‚îÇ                   ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄinitializer
‚îÇ   ‚îÇ   ‚îÇ                   ‚îú‚îÄ‚îÄ‚îÄcontroller
‚îÇ   ‚îÇ   ‚îÇ                   ‚îú‚îÄ‚îÄ‚îÄdto
‚îÇ   ‚îÇ   ‚îÇ                   ‚îÇ   ‚îú‚îÄ‚îÄ‚îÄrequest
‚îÇ   ‚îÇ   ‚îÇ                   ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄresponse
‚îÇ   ‚îÇ   ‚îÇ                   ‚îú‚îÄ‚îÄ‚îÄexception
‚îÇ   ‚îÇ   ‚îÇ                   ‚îú‚îÄ‚îÄ‚îÄfactory
‚îÇ   ‚îÇ   ‚îÇ                   ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄimpl
‚îÇ   ‚îÇ   ‚îÇ                   ‚îú‚îÄ‚îÄ‚îÄmodel
‚îÇ   ‚îÇ   ‚îÇ                   ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄenums
‚îÇ   ‚îÇ   ‚îÇ                   ‚îú‚îÄ‚îÄ‚îÄrepository
‚îÇ   ‚îÇ   ‚îÇ                   ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄprojection
‚îÇ   ‚îÇ   ‚îÇ                   ‚îú‚îÄ‚îÄ‚îÄservice
‚îÇ   ‚îÇ   ‚îÇ                   ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄimpl
‚îÇ   ‚îÇ   ‚îÇ                   ‚îî‚îÄ‚îÄ‚îÄutils
‚îÇ   ‚îÇ   ‚îÇ                       ‚îú‚îÄ‚îÄ‚îÄenums
‚îÇ   ‚îÇ   ‚îÇ                       ‚îî‚îÄ‚îÄ‚îÄmapper
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄresources
‚îÇ   ‚îî‚îÄ‚îÄ‚îÄtest
‚îÇ       ‚îî‚îÄ‚îÄ‚îÄjava
‚îÇ           ‚îî‚îÄ‚îÄ‚îÄeci
‚îÇ               ‚îî‚îÄ‚îÄ‚îÄcvds
‚îÇ                   ‚îî‚îÄ‚îÄ‚îÄecibeneficio
‚îÇ                       ‚îî‚îÄ‚îÄ‚îÄdiamante_medicalturns_service
‚îî‚îÄ‚îÄ‚îÄtarget
    ‚îú‚îÄ‚îÄ‚îÄclasses
    ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄeci
    ‚îÇ       ‚îî‚îÄ‚îÄ‚îÄcvds
    ‚îÇ           ‚îî‚îÄ‚îÄ‚îÄecibeneficio
    ‚îÇ               ‚îî‚îÄ‚îÄ‚îÄdiamante_medicalturns_service
    ‚îÇ                   ‚îú‚îÄ‚îÄ‚îÄconfig
    ‚îÇ                   ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄinitializer
    ‚îÇ                   ‚îú‚îÄ‚îÄ‚îÄcontroller
    ‚îÇ                   ‚îú‚îÄ‚îÄ‚îÄdto
    ‚îÇ                   ‚îÇ   ‚îú‚îÄ‚îÄ‚îÄrequest
    ‚îÇ                   ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄresponse
    ‚îÇ                   ‚îú‚îÄ‚îÄ‚îÄexception
    ‚îÇ                   ‚îú‚îÄ‚îÄ‚îÄfactory
    ‚îÇ                   ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄimpl
    ‚îÇ                   ‚îú‚îÄ‚îÄ‚îÄmodel
    ‚îÇ                   ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄenums
    ‚îÇ                   ‚îú‚îÄ‚îÄ‚îÄrepository
    ‚îÇ                   ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄprojection
    ‚îÇ                   ‚îú‚îÄ‚îÄ‚îÄservice
    ‚îÇ                   ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄimpl
    ‚îÇ                   ‚îî‚îÄ‚îÄ‚îÄutils
    ‚îÇ                       ‚îú‚îÄ‚îÄ‚îÄenums
    ‚îÇ                       ‚îî‚îÄ‚îÄ‚îÄmapper
    ‚îú‚îÄ‚îÄ‚îÄgenerated-sources
    ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄannotations
    ‚îú‚îÄ‚îÄ‚îÄgenerated-test-sources
    ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄtest-annotations
    ‚îú‚îÄ‚îÄ‚îÄmaven-status
    ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄmaven-compiler-plugin
    ‚îÇ       ‚îú‚îÄ‚îÄ‚îÄcompile
    ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄdefault-compile
    ‚îÇ       ‚îî‚îÄ‚îÄ‚îÄtestCompile
    ‚îÇ           ‚îî‚îÄ‚îÄ‚îÄdefault-testCompile
    ‚îú‚îÄ‚îÄ‚îÄsurefire-reports
    ‚îî‚îÄ‚îÄ‚îÄtest-classes
        ‚îî‚îÄ‚îÄ‚îÄeci
            ‚îî‚îÄ‚îÄ‚îÄcvds
                ‚îî‚îÄ‚îÄ‚îÄecibeneficio
                    ‚îî‚îÄ‚îÄ‚îÄdiamante_medicalturns_service
```

---

## üìù Documentaci√≥n del C√≥digo

Todo el c√≥digo fuente cuenta con documentaci√≥n mediante JavaDoc:

- üìò **Clases** documentadas con su prop√≥sito.
- üîß **M√©todos** descritos con entradas, salidas y comportamiento.
- üß© **Propiedades** explicadas seg√∫n su funci√≥n dentro del modelo.

---

**üìå Nota:** Este README se actualizar√° conforme avance el desarrollo del proyecto.
